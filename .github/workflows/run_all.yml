name: Run CRI pipeline

on:
  workflow_dispatch:
    inputs:
      figs_only:
        description: "Only build figures (skip long simulations)"
        type: boolean
        default: false
      skip_tex:
        description: "Skip LaTeX/TikZ build (faster; default)"
        type: boolean
        default: true
      auto_install:
        description: "pip install -r requirements.txt"
        type: boolean
        default: true
      skip_diag:
        description: "Skip SI diagnostics (kernel + calibration)"
        type: boolean
        default: false

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11 with pip cache
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            utilities/requirements.txt
            **/pyproject.toml

      - name: Install Python deps
        if: ${{ github.event.inputs.auto_install != 'false' }}
        run: |
          python -m pip install --upgrade pip
          if [ -f utilities/requirements.txt ]; then
            python -m pip install -r utilities/requirements.txt
          else
            echo "No utilities/requirements.txt found; installing minimal stack."
            python -m pip install numpy pandas scipy matplotlib PyYAML
          fi

      - name: Run pipeline
        env:
          # Map boolean strings to "1"/"0" for run_all.sh
          CRI_FIGS_ONLY:   ${{ github.event.inputs.figs_only == 'true' && '1' || '0' }}
          CRI_SKIP_TEX:    ${{ github.event.inputs.skip_tex  == 'true' && '1' || '0' }}
          CRI_AUTO_INSTALL: ${{ github.event.inputs.auto_install == 'true' && '1' || '0' }}
          CRI_SKIP_DIAG:   ${{ github.event.inputs.skip_diag == 'true' && '1' || '0' }}
        run: |
          chmod +x run_all.sh
          ./run_all.sh

      - name: Upload figures
        uses: actions/upload-artifact@v4
        with:
          name: figures-output
          path: figures/output/**

      - name: Upload logistic outputs
        uses: actions/upload-artifact@v4
        with:
          name: logistic-gate-output
          path: logistic_gate/output/**

      - name: Upload other outputs
        uses: actions/upload-artifact@v4
        with:
          name: all-outputs
          path: |
            decay/output/**
            tierB_tempered/output/**
            qpt/**/output/**
            preprocessing/output/**
            epochs_features/output/**
            statistics/output/**

